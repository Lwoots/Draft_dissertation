---
title: "Chapt 3 Methods"
author: "Lara Wootton"
date: "26/06/2020"
output:
    word_document:
       reference_docx: Draft_17032020.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Methods

## Dating analyses

Molecular dating made use of the targeted-enrichment dataset compiled in Chapter 2, but with reduced taxon sampling. Included were a single accession per species in the Ramosa, Rehmannii and Setacea clades, as delimited in Chapter 2, and one accession per taxon in the Lowlands and Dura clades. In addition, *O. sativa* was included as an outgroup and _Microlaena stipoides_ to represent the Australasian clade. The selection of representative accessions was based on sequencing coverage and completeness of morphological data. The possibility of multiple species within the Western Ramosa clade warranted the inclusion of two accessions from this group, while three accessions of _E. calycina_, corresponding to forms ("robust", "gracile" and "Clanwilliam") that likely represent distinct species [@Musker], and accessions of all subspecies of both *E. villosa* and *E. brevifolia* were included, resulting in a total of 42 taxa.

Owing to the computational demands of dating methods, running an analysis on the full number of loci was unfeasible. Instead, ten sets of 25 supercontig loci were drawn randomly from a pool consisting of the 308 supercontig loci from the ninety percent coverage dataset of Chapter 2, following the methods of @Stubbs2018. In addition, the gene "shopping" SortaDate package [@Smith2018] was used to choose the 25 "best" and 25 "worst" loci, by generating gene trees for each locus with IQTREE v.1.6.11 [@Nguyen2015], and then ranking the gene trees first by their concordance with the ASTRAL species tree, then by the extent to which their evolution is clock-like, and finally their length (-order 3,1,2). The loci within each set were individually aligned using MAFFT v.7.427 [@Katoh2013], with TrimAL v.1.2 being used to remove gappy regions under the -automated1 option [@Capella2009]. Thereafter, the trimmed loci were concatenated and partitioned using AMAS [@Borowiec2016]. IQTREE was used to find which of the substitution models incorporated in BEAST v1.10.4 [@Drummond2007; @Suchard2018] were suitable for each locus with the option -mset JC, HKY, GTR, TN93. BEAUTi v1.10.4 [@Suchard2018] was used to configure xml files for input into BEAST. All loci were parameterised using unlinked substitution models corresponding to the best model found by IQTREE, while clock and tree models were linked across the loci. Taxon relationships were constrained to correspond to the topology of the ASTRAL tree in Chapter 2. Two calibration points with normal priors were used based on the fossil-calibrated tree of @Prasad2011, one constraining the split between _O. sativa_ and _Ehrharta_ at 72.5 Ma (sd = 5.61, 95% CI = 66.89 - 78.11), and the other between _M. stipoides_ and the Setacea clade at 20 MYA (sd = 7.65). BEAST analyses were run using a birth-death tree prior and relaxed uncorrelated lognormal clock model, sampling parameters every 1000 generations. Four replicate BEAST runs of 50 million generations per loci set were used to confirm convergence and stationarity through visualisation in TRACER v1.7.1 [@Rambaut2018], and a fifth replicate of 250 million generations was run to ensure that the Estimated Sample Size (ESS) for each parameter had an approximate value of >100. The five for each set of loci were combined using LogCombiner v1.10.4 [@Suchard2018] with a burn in of 10 million generations per replicate, with the exception of the Sortadate 'best' loci set, which took longer to reach stationarity and required a burn in of 20 million generations. TreeAnnotator v1.10.4 [@Suchard2018] was used to construct maximum clade credibility trees and summary statistics. Analyses were conducted either using CIPRES Science Gateway [@Miller2010] or the facilities of the University of Cape Townâ€™s ICTS High Performance Computing unit.

## Diversification analyses

To test whether rates of diversification differed between clades, BAMM v2.5.0 [@Rabosky2014] was used to model potential rate shifts. Although BAMM can account for incomplete taxon sampling within a tree [@Rabosky2014], this work is explicitly interested in the diversification within the Cape _Ehrharta_ and therefore excluded unsampled _Ehrharta_ species occurring outside the Cape, such as _E. longiglumis_, as well as _O. sativa_ and _M. stipoides_ were excluded from the analysis. Priors for each of the twelve BEAST trees were generated using the function "setBAMMpriors" from the R package _BAMMTools_ [@Rabosky2014b]. For all trees, the expected number of diversification rate shifts was set to one, based on evidence for an adaptive radiation within the Lowlands clade [@Verboom2003; @Verboom2004]. BAMM was run for 3 million generations, sampling every 1000 generations. Convergence and ESS were checked using the R package _Coda_ [@Plummer2006]. The 95% credible set of rate shift configurations was extracted with the function "credibleShiftSet", with the marginal posterior-to-prior odds ratio for detecting a rate shift set to five. In addition, the mean rates of diversification within each of the Lowlands, Succulent Karoo, Ramosa and Setacea clades were calculated using the function "getCladeRates" [@Rabosky2014b], and tested for significant differences using an Kruskal-Wallis test. As a control to investigate the influence of the postulated new taxa outlined in Chapter 2, the analysis was then repeated with the BEAST trees trimmed to correspond to the phylogeny of @Verboom2003; for this purpose, only one accession corresponding to each of _E. setacea_, _E. rupestris_, _E. rehmannii_, _E. calycina_, _E. villosa_, and _E. brevifolia_ were retained.

## Rates of morphological change

The non-censored model of @OMeara2006 was used in order to evaluate whether the Lowlands, Ramosa and Setacea clades each had a different rate of morphological evolution in comparison to the rest of the tree. This method was chosen as it allows for specific, _a priori_ hypothesis testing, rather than searching for rate shifts anywhere on the tree [e.g. @Eastman]. For each of the ten BEAST trees, the rate of evolution of a single log-transformed trait within one of the three clades was compared to the rate of the trait's evolution within the rest of the tree using the function "transformPhylo.ML" and the model = "clade" argument from the R package _MOTMOT_ [@Puttick2019]. Sixteen different morphological traits, as described in Chapter 2 and measured on the exact individuals used in the BEAST trees, were included in the analysis. The trait variance across the trees was visualised using the function "contmap" implemented in the R package _phytools_ [@Revell2012], and a Levene's test for equal variance [@Levene1960], followed by a Tukey HSD post-hoc test, was used to evaluate whether the actual degree of observed trait disparity varied between clades. 

## Rate of non-synonymous to synonymous change



The codeml program from the PAML package [v4.9, @Yang] was used to infer synonymous and non-synonymous rate of change. First, the loci contained in ninety percent coverage exon dataset from Chapter 2 for the Cape _Ehrharta_ included in the BEAST analysis were aligned using the codon-aware alignment program MACSE v2.03 [@Macse]. Summary statistics for each alignment were then calculated using AMAS [@boweric], and only loci containing <25% gap characters, >20% variable sites, and had no missing taxa were retained for the analysis, leaving a total of 44 loci. The loci were concatenated into a single alignment, and columns containing >5% gaps were removed using TrimAl v.1.2 with the setting -gt 95 [@Capella2009]. As codeml isn't sensitive to initial branch lengths, a single unrooted BEAST tree was used for all codeml analyses [@ref]. The free-ratios model was implemented to estimate dN, dS and $\omega$ for each branch (model = 1,  NSsites = 0); the rates for the terminal branches were grouped by clade, and an ANOVA followed by a Tukey HSD post-hoc test was used to test for significant differences between clades. In addition, two-rate models were fitted that allowed the $\omega$ of foreground branches, in this case all branches within a given clade, to differ from the remaining background branches [model = 2, NSsites = 0, @Yang1998; @Yang1998b]. A likelihood-ratio test was then used to evaluate whether the two-rate models were significantly better than a the one-rate branch model (model = 0, NSsites = 0), which estimates a single $\omega$ across the tree.



